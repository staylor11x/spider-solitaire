name: Build Release Binaries 

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  actions: read

jobs:
  build:
    name: Build ${{ matrix.goos }}-${{ matrix.goarch }}
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        include:
          # windows build
          - os: windows-latest
            goos: windows
            goarch: amd64
            binary_name: spider-solitaire.exe

          # linux build
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
            binary_name: spider-solitaire

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Install Linux dependencies
        if: matrix.goos == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-dev xorg-dev libasound2-dev

      - name: Get version and build time
        id: version
        shell: bash
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION at $BUILD_TIME"  
        
      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          go build -v \
            -ldflags="-s -w -X main.Version=${{ steps.version.outputs.VERSION }} -X main.BuildTime=${{ steps.version.outputs.BUILD_TIME }}" \
            -o ${{ matrix.binary_name }} \
            ./cmd/game

      - name: Create artifact name
        id: artifact
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          ARTIFACT_NAME="spider-solitaire-${VERSION}-${{ matrix.goos }}-${{ matrix.goarch }}"

          # add .exe extension for Windows
          if [ "${{ matrix.goos }}" = "windows" ]; then  
          fi

          echo "ARTIFACT_NAME=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
          echo "Artifact will be named: $ARTIFACT_NAME"

      - name: Rename binary for upload
        shell: bash
        run: |
          mv ${{ matrix.binary_name }} ${{ steps.artifact.outputs.ARTIFACT_NAME }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact.outputs.ARTIFACT_NAME }}
          path: ${{ steps.artifact.outputs.ARTIFACT_NAME }}
          retention-days: 90
          if-no-files-found: error

      - name: Build summary
        shell: bash
        run: |
          echo "### âœ… Build Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Platform:** ${{ matrix.goos }}-${{ matrix.goarch }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY 
          echo "**Build Time:** ${{ steps.version.outputs.BUILD_TIME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Artifact:** \`${{ steps.artifact.outputs.ARTIFACT_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          
          # show file size
          if [ "${{ matrix.goos }}" = "windows" ]; then
            SIZE=$(stat -c%s "${{ steps.artifact.outputs.ARTIFACT_NAME }}" 2>/dev/null || stat -f%z "${{ steps.artifact.outputs.ARTIFACT_NAME }}" 2>/dev/null || echo "unknown")
          else
            SIZE=$(stat -c%s "${{ steps.artifact.outputs.ARTIFACT_NAME }}" 2>/dev/null || echo "unknown")  
          fi
            
          if [ "$SIZE" != "unknown" ]; then
            SIZE_MB=$((SIZE / 1024 / 1024))
            echo "**Size:** ${SIZE_MB} MB" >> $GITHUB_STEP_SUMMARY 
          fi